<div class="flex w-full flex-auto flex-col">

  <!-- Header -->
  <div class="relative flex flex-0 flex-col border-b px-6 py-8 sm:flex-row sm:items-center sm:justify-between md:px-8">

    <!-- Loader -->
    @if (isLoading) {
      <div class="absolute inset-x-0 bottom-0">
        <mat-progress-bar [mode]="'indeterminate'"></mat-progress-bar>
      </div>
    }

    <!-- Title -->
    <div>
      <h2 class="text-3xl font-semibold leading-8 tracking-tight">
        Registrar cliente
      </h2>
      <div class="text-secondary font-medium tracking-tight">
        Captura los datos fiscales, dirección y preferencias de facturación
      </div>
    </div>

    <!-- Actions -->
    <div class="mt-6 flex shrink-0 items-center gap-3 sm:ml-4 sm:mt-0">
      <button mat-stroked-button (click)="cancelar()" [disabled]="isLoading">
        <mat-icon class="mr-2">arrow_back</mat-icon>
        Volver
      </button>

      <button mat-flat-button color="accent" (click)="actualizarDatos()" [disabled]="form.invalid || isLoading">
        <mat-icon class="mr-2">save</mat-icon>
        Guardar
      </button>
    </div>
  </div>

  <!-- Content -->
  <div class="mx-auto w-full max-w-screen-xl px-3 py-4" [formGroup]="form">

    <!-- Datos del cliente -->
    <div class="bg-card rounded-2xl shadow p-4">
      <div class="mb-3">
        <div class="text-lg font-semibold">Datos del cliente</div>
        <div class="text-secondary text-sm">Información fiscal y de contacto</div>
      </div>

      <div class="grid grid-cols-12 gap-4">

        <!-- Tipo persona -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-3">
          <mat-label>Tipo de persona</mat-label>
          <mat-select formControlName="tipoPersona">
            <mat-option [value]="'M'">Moral</mat-option>
            <mat-option [value]="'F'">Física</mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('tipoPersona')?.touched && form.get('tipoPersona')?.invalid">
            Selecciona un tipo de persona
          </mat-error>
        </mat-form-field>

        <!-- RFC -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-3">
          <mat-label>RFC</mat-label>
          <input matInput formControlName="rfc" autocomplete="off" />
          <mat-hint>Sin espacios, en mayúsculas</mat-hint>
          <mat-error *ngIf="form.get('rfc')?.touched && form.get('rfc')?.hasError('required')">
            RFC es requerido
          </mat-error>
          <mat-error *ngIf="form.get('rfc')?.touched && form.get('rfc')?.hasError('maxlength')">
            RFC no puede exceder 13 caracteres
          </mat-error>
        </mat-form-field>

        <!-- Razón social -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-6">
          <mat-label>Razón social</mat-label>
          <input matInput formControlName="razonSocial" autocomplete="off" />
          <mat-error *ngIf="form.get('razonSocial')?.touched && form.get('razonSocial')?.hasError('required')">
            Razón social es requerida
          </mat-error>
          <mat-error *ngIf="form.get('razonSocial')?.touched && form.get('razonSocial')?.hasError('maxlength')">
            Máximo 250 caracteres
          </mat-error>
        </mat-form-field>

        <!-- Nombre comercial -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-6">
          <mat-label>Nombre comercial (opcional)</mat-label>
          <input matInput formControlName="nombreComercial" autocomplete="off" />
          <mat-error *ngIf="form.get('nombreComercial')?.touched && form.get('nombreComercial')?.hasError('maxlength')">
            Máximo 150 caracteres
          </mat-error>
        </mat-form-field>

        <!-- Régimen fiscal -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-6">
          <mat-label>Régimen fiscal</mat-label>
          <mat-select formControlName="regimenFiscal">
            <mat-option [value]="''">Seleccione...</mat-option>
            <mat-option *ngFor="let cat of regimenesFiscales" [value]="cat.id">
              {{ cat.descripcion }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('regimenFiscal')?.touched && form.get('regimenFiscal')?.hasError('required')">
            Régimen fiscal es requerido
          </mat-error>
        </mat-form-field>

        <!-- Email -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-4">
          <mat-label>Email</mat-label>
          <input matInput formControlName="email" autocomplete="off" />
          <mat-error *ngIf="form.get('email')?.touched && form.get('email')?.hasError('email')">
            Email inválido
          </mat-error>
          <mat-error *ngIf="form.get('email')?.touched && form.get('email')?.hasError('maxlength')">
            Máximo 50 caracteres
          </mat-error>
        </mat-form-field>

        <!-- Correos CC -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-4">
          <mat-label>Correos adicionales (CC)</mat-label>
          <input matInput formControlName="correosCc" autocomplete="off" />
          <mat-hint>Separar con “;” o “,”</mat-hint>
          <mat-error *ngIf="form.get('correosCc')?.touched && form.get('correosCc')?.hasError('emailsList')">
            Uno o más correos no tienen formato válido
          </mat-error>
          <mat-error *ngIf="form.get('correosCc')?.touched && form.get('correosCc')?.hasError('maxlength')">
            Máximo 500 caracteres
          </mat-error>
        </mat-form-field>

        <!-- Teléfono -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-4">
          <mat-label>Teléfono</mat-label>
          <input matInput formControlName="telefono" autocomplete="off" />
          <mat-error *ngIf="form.get('telefono')?.touched && form.get('telefono')?.hasError('pattern')">
            Teléfono inválido
          </mat-error>
          <mat-error *ngIf="form.get('telefono')?.touched && form.get('telefono')?.hasError('maxlength')">
            Máximo 50 caracteres
          </mat-error>
        </mat-form-field>

        <!-- Notas -->
        <mat-form-field appearance="fill" class="col-span-12">
          <mat-label>Notas internas (opcional)</mat-label>
          <textarea matInput formControlName="notas" rows="3"></textarea>
          <mat-hint>Visible solo en tu sistema (no se incluye en CFDI)</mat-hint>
          <mat-error *ngIf="form.get('notas')?.touched && form.get('notas')?.hasError('maxlength')">
            Máximo 500 caracteres
          </mat-error>
        </mat-form-field>

      </div>
    </div>

    <!-- Dirección fiscal -->
    <div class="bg-card rounded-2xl shadow p-4 mt-4">
      <div class="mb-3">
        <div class="text-lg font-semibold">Dirección fiscal</div>
        <div class="text-secondary text-sm">Se autocompleta Estado/Municipio con el Código Postal</div>
      </div>

      <div class="grid grid-cols-12 gap-4">

        <!-- País -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-3">
          <mat-label>País</mat-label>
          <mat-select formControlName="pais">
            <mat-option [value]="''">Seleccione...</mat-option>
            <mat-option *ngFor="let pais of paises" [value]="pais.id">
              {{ pais.descripcion }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('pais')?.touched && form.get('pais')?.hasError('required')">
            País es requerido
          </mat-error>
        </mat-form-field>

        <!-- CP -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-3">
          <mat-label>Código postal</mat-label>
          <input matInput formControlName="codigoPostal" autocomplete="off" />
          <mat-error *ngIf="form.get('codigoPostal')?.touched && form.get('codigoPostal')?.hasError('required')">
            Código postal es requerido
          </mat-error>
          <mat-error *ngIf="form.get('codigoPostal')?.touched && form.get('codigoPostal')?.hasError('pattern')">
            Debe ser de 5 dígitos
          </mat-error>
        </mat-form-field>

        <!-- Estado -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-3">
          <mat-label>Estado</mat-label>
          <input matInput formControlName="estado" readonly />
          <mat-error *ngIf="form.get('estado')?.touched && form.get('estado')?.hasError('required')">
            Estado es requerido
          </mat-error>
        </mat-form-field>

        <!-- Municipio -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-3">
          <mat-label>Municipio</mat-label>
          <input matInput formControlName="municipio" readonly />
          <mat-error *ngIf="form.get('municipio')?.touched && form.get('municipio')?.hasError('required')">
            Municipio es requerido
          </mat-error>
        </mat-form-field>

        <!-- Localidad -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-6">
          <mat-label>Localidad (opcional)</mat-label>
          <input matInput formControlName="localidad" autocomplete="off" />
          <mat-error *ngIf="form.get('localidad')?.touched && form.get('localidad')?.hasError('maxlength')">
            Máximo 80 caracteres
          </mat-error>
        </mat-form-field>

        <!-- Colonia -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-6">
          <mat-label>Colonia</mat-label>
          <mat-select formControlName="colonia">
            <mat-option [value]="''">Seleccione...</mat-option>
            <mat-option *ngFor="let colonia of colonias" [value]="colonia">
              {{ colonia }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('colonia')?.touched && form.get('colonia')?.hasError('required')">
            Colonia es requerida
          </mat-error>
        </mat-form-field>

        <!-- Calle -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-6">
          <mat-label>Calle</mat-label>
          <input matInput formControlName="calle" autocomplete="off" />
          <mat-error *ngIf="form.get('calle')?.touched && form.get('calle')?.hasError('required')">
            Calle es requerida
          </mat-error>
          <mat-error *ngIf="form.get('calle')?.touched && form.get('calle')?.hasError('maxlength')">
            Máximo 150 caracteres
          </mat-error>
        </mat-form-field>

        <!-- Referencia -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-6">
          <mat-label>Referencia (opcional)</mat-label>
          <input matInput formControlName="referencia" autocomplete="off" />
          <mat-error *ngIf="form.get('referencia')?.touched && form.get('referencia')?.hasError('maxlength')">
            Máximo 150 caracteres
          </mat-error>
        </mat-form-field>

        <!-- No. Exterior -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-3">
          <mat-label>Número exterior</mat-label>
          <input matInput formControlName="noExterior" autocomplete="off" />
          <mat-error *ngIf="form.get('noExterior')?.touched && form.get('noExterior')?.hasError('required')">
            Número exterior es requerido
          </mat-error>
          <mat-error *ngIf="form.get('noExterior')?.touched && form.get('noExterior')?.hasError('maxlength')">
            Máximo 50 caracteres
          </mat-error>
        </mat-form-field>

        <!-- No. Interior -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-3">
          <mat-label>Número interior (opcional)</mat-label>
          <input matInput formControlName="noInterior" autocomplete="off" />
          <mat-error *ngIf="form.get('noInterior')?.touched && form.get('noInterior')?.hasError('maxlength')">
            Máximo 50 caracteres
          </mat-error>
        </mat-form-field>

      </div>
    </div>

    <!-- Datos adicionales / Defaults -->
    <div class="bg-card rounded-2xl shadow p-4 mt-4">
      <div class="mb-3">
        <div class="text-lg font-semibold">Preferencias de facturación (opcional)</div>
        <div class="text-secondary text-sm">Se usarán como valores por defecto al facturar</div>
      </div>

      <div class="grid grid-cols-12 gap-4">

        <!-- Método de pago -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-3">
          <mat-label>Método de pago</mat-label>
          <mat-select formControlName="metodoPago">
            <mat-option [value]="''">Seleccione...</mat-option>
            <mat-option *ngFor="let item of metodosPago" [value]="item.metodoPagoId">
              {{ item.metodoPagoId }} - {{ item.descripcion }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Forma de pago -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-3">
          <mat-label>Forma de pago</mat-label>
          <mat-select formControlName="formaPago">
            <mat-option [value]="''">Seleccione...</mat-option>
            <mat-option *ngFor="let item of formasPago" [value]="item.cFormaPago1">
              {{ item.cFormaPago1 }} - {{ item.descripcion }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Moneda -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-3">
          <mat-label>Moneda</mat-label>
          <mat-select formControlName="moneda">
            <mat-option [value]="''">Seleccione...</mat-option>
            <mat-option *ngFor="let item of monedas" [value]="item.cMoneda">
              {{ item.cMoneda }} - {{ item.descripcion }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Exportación -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-3">
          <mat-label>Exportación</mat-label>
          <mat-select formControlName="exportacion">
            <mat-option [value]="''">Seleccione...</mat-option>
            <mat-option *ngFor="let item of exportaciones" [value]="item.cExportacion1">
              {{ item.cExportacion1 }} - {{ item.descripcion }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Uso CFDI -->
        <mat-form-field appearance="fill" class="col-span-12 sm:col-span-6">
          <mat-label>Uso CFDI</mat-label>
          <mat-select formControlName="usoCfdi">
            <mat-option [value]="''">Seleccione...</mat-option>
            <mat-option *ngFor="let item of usosCfdi" [value]="item.cUsoCfdi1">
              {{ item.cUsoCfdi1 }} - {{ item.descripcion }}
            </mat-option>
          </mat-select>
        </mat-form-field>

      </div>
    </div>

    <!-- Footer actions -->
    <div class="flex justify-end gap-3 mt-4">
      <button mat-stroked-button (click)="cancelar()" [disabled]="isLoading">
        Cancelar
      </button>

      <button mat-flat-button color="accent" (click)="actualizarDatos()" [disabled]="form.invalid || isLoading">
        <ng-container *ngIf="!isLoading; else loadingTpl">
          Guardar
        </ng-container>

        <ng-template #loadingTpl>
          <mat-progress-spinner diameter="18" mode="indeterminate"></mat-progress-spinner>
        </ng-template>
      </button>
    </div>

  </div>
</div>